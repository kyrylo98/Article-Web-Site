{% extends "base.html" %}

{% block title %}
  {% if form.instance.pk %}Edit article{% else %}Create article{% endif %}
{% endblock %}

{% block content %}
<section class="section">
  <div class="container">

    <div class="hero-gradient">
      <h1 class="page-title">
        {% if form.instance.pk %}Edit{% else %}Create{% endif %} article
      </h1>
      <p class="page-sub">
        Write modern, clean articles. Keep it short and readable.
      </p>
    </div>

    <div class="card card--glass form-card">
      <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
          <div class="alert">{{ form.non_field_errors }}</div>
        {% endif %}

        <!-- Title -->
        <div class="field">
          {{ form.title.label_tag }}
          {{ form.title }}
          {% if form.title.errors %}
            <div class="error">{{ form.title.errors|striptags }}</div>
          {% endif %}
        </div>

        <!-- Description with counter -->
        <div class="field">
          <div class="label-row">
            {{ form.description.label_tag }}
            <span class="muted" id="desc-count">0/160</span>
          </div>
          {{ form.description }}
          {% if form.description.errors %}
            <div class="error">{{ form.description.errors|striptags }}</div>
          {% endif %}
          <p class="hint">
            Short summary (≤ 160 characters) for list and SEO.
          </p>
        </div>

        <!-- Category -->
        <div class="field">
          {{ form.category.label_tag }}
          {{ form.category }}
          {% if form.category.errors %}
            <div class="error">{{ form.category.errors|striptags }}</div>
          {% endif %}
          <p class="hint">Choose a category for better navigation.</p>
        </div>

        <!-- Image with pretty file name -->
        <div class="field">
          {{ form.image.label_tag }}
          <div class="file-wrap">
            {{ form.image }}
            <span class="file-cta">Choose image</span>
            <span class="file-name" id="file-name">No file chosen</span>
          </div>
          {% if form.image.errors %}
            <div class="error">{{ form.image.errors|striptags }}</div>
          {% endif %}
        </div>

        <!-- Body with read time -->
        <div class="field">
          <div class="label-row">
            {{ form.body.label_tag }}
            <span class="muted" id="read-meter">~ 1 min read</span>
          </div>
          {{ form.body }}
          {% if form.body.errors %}
            <div class="error">{{ form.body.errors|striptags }}</div>
          {% endif %}
        </div>

        <!-- Published -->
        <div class="field inline">
          <label class="checkbox" for="{{ form.is_published.id_for_label }}">
            {{ form.is_published }} <span>Published?</span>
          </label>
        </div>

        <!-- Actions -->
        <div class="actions">
          <button class="cta" type="submit">Save</button>
          <a class="cta secondary" href="{% url 'articles:index' %}">Cancel</a>

          {# Delete — только автору или staff. Без скобок, только вложенные if. #}
          {% if request.user.is_authenticated %}
            {% if form.instance.pk %}
              {% if request.user.is_staff or request.user.pk == form.instance.author_id %}
                <a class="cta secondary"
                   href="{% url 'articles:delete' form.instance.pk %}">
                  Delete
                </a>
              {% endif %}
            {% endif %}
          {% endif %}
        </div>
      </form>
    </div>

  </div>
</section>

<script>
(function () {
  function byId(id) { return document.getElementById(id); }

  var descId   = "{{ form.description.id_for_label }}";
  var bodyId   = "{{ form.body.id_for_label }}";
  var imageId  = "{{ form.image.id_for_label }}";

  var descEl       = descId ? byId(descId) : null;
  var descCountEl  = byId("desc-count");
  var bodyEl       = bodyId ? byId(bodyId) : null;
  var readMeterEl  = byId("read-meter");
  var fileInputEl  = imageId ? byId(imageId) : null;
  var fileNameEl   = byId("file-name");

  function updateDescCounter() {
    if (!descEl || !descCountEl) return;
    var len = (descEl.value || "").length;
    if (len > 160) len = 160;
    descCountEl.textContent = len + "/160";
  }

  function estimateMinutes(text) {
    var words = (text || "").trim().split(/\s+/).filter(Boolean).length;
    return Math.max(1, Math.round(words / 200));
  }

  function updateReadMeter() {
    if (!bodyEl || !readMeterEl) return;
    readMeterEl.textContent = "~ " + estimateMinutes(bodyEl.value) + " min read";
  }

  function updateFileName() {
    if (!fileInputEl || !fileNameEl) return;
    fileNameEl.textContent =
      (fileInputEl.files && fileInputEl.files.length)
        ? fileInputEl.files[0].name
        : "No file chosen";
  }

  if (descEl)  { updateDescCounter(); descEl.addEventListener("input", updateDescCounter); }
  if (bodyEl)  { updateReadMeter();   bodyEl.addEventListener("input", updateReadMeter); }
  if (fileInputEl) { updateFileName(); fileInputEl.addEventListener("change", updateFileName); }
})();
</script>
{% endblock %}
